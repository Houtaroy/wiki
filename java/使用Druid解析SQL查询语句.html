<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用Druid解析SQL查询语句 | Houtaroy Wiki</title>
    <meta name="description" content="给时光以生命, 而不是给生命以时光">
    <link rel="stylesheet" href="/wiki/assets/style.5f10c5ca.css">
    <link rel="modulepreload" href="/wiki/assets/chunks/AlgoliaSearchBox.1f22568a.js">
    <link rel="modulepreload" href="/wiki/assets/app.7004e06b.js">
    <link rel="modulepreload" href="/wiki/assets/java_使用Druid解析SQL查询语句.md.fed2d013.lean.js">
    
    <meta name="twitter:title" content="使用Druid解析SQL查询语句 | Houtaroy Wiki">
  <meta property="og:title" content="使用Druid解析SQL查询语句 | Houtaroy Wiki">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-2ba227d5><div class="sidebar-button" data-v-2ba227d5><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/wiki/" aria-label="Houtaroy Wiki, back to home" data-v-2ba227d5 data-v-b3da5816><!----> Houtaroy Wiki</a><div class="flex-grow" data-v-2ba227d5></div><div class="nav" data-v-2ba227d5><nav class="nav-links" data-v-2ba227d5 data-v-0fce24fe><!--[--><div class="item" data-v-0fce24fe><div class="nav-link" data-v-0fce24fe data-v-2cb643ba><a class="item active" href="/wiki/java/" data-v-2cb643ba>Java <!----></a></div></div><div class="item" data-v-0fce24fe><div class="nav-link" data-v-0fce24fe data-v-2cb643ba><a class="item" href="/wiki/training-record/micro-service" data-v-2cb643ba>培训记录 <!----></a></div></div><!--]--><!----><!----></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-79af364c><nav class="nav-links nav" data-v-79af364c data-v-0fce24fe><!--[--><div class="item" data-v-0fce24fe><div class="nav-link" data-v-0fce24fe data-v-2cb643ba><a class="item active" href="/wiki/java/" data-v-2cb643ba>Java <!----></a></div></div><div class="item" data-v-0fce24fe><div class="nav-link" data-v-0fce24fe data-v-2cb643ba><a class="item" href="/wiki/training-record/micro-service" data-v-2cb643ba>培训记录 <!----></a></div></div><!--]--><!----><!----></nav><!--[--><!--]--><ul class="sidebar-links" data-v-79af364c><!--[--><li class="sidebar-link"><p class="sidebar-link-item">Java</p><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/wiki/java/">目录</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wiki/java/开发手册">开发手册</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/wiki/java/使用Druid解析SQL查询语句">使用Druid解析SQL查询语句</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-前言">1 前言</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-需求分析">2 需求分析</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#解析查询列">解析查询列</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#解析自定义查询参数">解析自定义查询参数</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-技术选型">3 技术选型</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#sql解析">SQL解析</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#sql编译">SQL编译</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-研究与实现">4 研究与实现</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-1-sql抽象语法树">4.1 SQL抽象语法树</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-2-访问者模式">4.2 访问者模式</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-3-是否有轮子">4.3 是否有轮子?</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-4-创建模型">4.4 创建模型</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-5-创建访问者">4.5 创建访问者</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-6-sql注入检查">4.6 SQL注入检查</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_5-总结">5 总结</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wiki/java/SpringBoot整合钉钉SDK">SpringBoot整合钉钉SDK</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wiki/java/SpringCloud分布式事务Seata">SpringCloud分布式事务Seata</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/wiki/java/SpringBoot整合Elasticsearch/">SpringBoot整合Elasticsearch</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-30e7de44><div class="container" data-v-30e7de44><!--[--><!--]--><div style="position:relative;" class="content" data-v-30e7de44><div><h1 id="使用druid解析sql查询语句" tabindex="-1">使用Druid解析SQL查询语句 <a class="header-anchor" href="#使用druid解析sql查询语句" aria-hidden="true">#</a></h1><h2 id="_1-前言" tabindex="-1">1 前言 <a class="header-anchor" href="#_1-前言" aria-hidden="true">#</a></h2><p>阅读本篇文章您可以了解到如下内容:</p><ul><li>Druid SQL Parser</li><li>访问者模式</li><li>MyBatis</li></ul><p>在此之前, 如果您阅读以下内容可更好的进行理解:</p><ul><li><a href="https://github.com/alibaba/druid/wiki/Druid_SQL_AST" target="_blank" rel="noopener noreferrer">Druid SQL AST</a></li><li><a href="https://github.com/alibaba/druid/wiki/SQL-Parser" target="_blank" rel="noopener noreferrer">Druid SQL Parser</a></li><li><a href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html" target="_blank" rel="noopener noreferrer">MyBatis XML映射相关</a></li></ul><h2 id="_2-需求分析" tabindex="-1">2 需求分析 <a class="header-anchor" href="#_2-需求分析" aria-hidden="true">#</a></h2><p>需求来自于公司项目, 简单提取出以下几点:</p><ol><li>解析查询列</li><li>解析自定义查询参数</li><li>根据查询参数编译SQL语句并进行查询</li><li>防止SQL注入</li></ol><p>对其中的部分内容详细阐述:</p><h3 id="解析查询列" tabindex="-1">解析查询列 <a class="header-anchor" href="#解析查询列" aria-hidden="true">#</a></h3><p>短短五个字, 却包含了许多内容, 首先列举下常用的查询列情况:</p><ol><li>列名, 例如<code>select name from t_user</code>中的<code>name</code></li><li>有别名的列, 例如<code>select gender as sex from t_user</code>中的<code>gender as sex</code></li><li>方法, 例如<code>select concat(name, email) from t_user</code>中的<code>concat(name, email)</code></li><li>全部列, 例如<code>select * from t_user</code></li></ol><h3 id="解析自定义查询参数" tabindex="-1">解析自定义查询参数 <a class="header-anchor" href="#解析自定义查询参数" aria-hidden="true">#</a></h3><p>这个需求主要看约束了, 我们讨论使用MyBatis的写法, 例如: <code>select * from t_user where id = #{id} and name like &#39;#{name}%&#39;</code></p><p>最后提取的结果为<code>[&#39;id&#39;, &#39;name&#39;]</code>即可</p><h2 id="_3-技术选型" tabindex="-1">3 技术选型 <a class="header-anchor" href="#_3-技术选型" aria-hidden="true">#</a></h2><p>通过需求分析, 我们可以将工作主要分为三个模块: <strong>SQL解析</strong>/<strong>SQL编译</strong>/<strong>SQL执行</strong></p><p>由于公司使用的是MyBatis, 所以SQL执行方式自然是字符换替换, 那SQL执行的需求可以进一步缩小为<strong>防止SQL注入</strong></p><h3 id="sql解析" tabindex="-1">SQL解析 <a class="header-anchor" href="#sql解析" aria-hidden="true">#</a></h3><p>由于自定义查询参数书写格式固定, 我们只需要正确的解析出SQL的查询条件, 再利用正则提取内容即可</p><p>所以如何正确解析SQL成为关键</p><p>通过网上冲浪, 总结出了如下开源方案:</p><ol><li>Antlr</li><li>Apache Calcite</li><li>Druid</li><li>JSqlParser</li><li>sharding-JDBC</li></ol><p>由于业务并不复杂, 偏重量级的Antlr/基于Antlr实现的sharding-JDBC首先排除</p><p>其次排除的是JSqlParser, 它虽然使用便捷, 但不支持<code>{}</code>的输入, 会对自定义参数的解析产生影响</p><p>最后选择Druid的原因有如下两点:</p><ol><li>中文文档且详细, 便于理解和开发</li><li>本功能为支撑功能, 后续会有其它开发人员介入, 英文水平不可控</li></ol><h3 id="sql编译" tabindex="-1">SQL编译 <a class="header-anchor" href="#sql编译" aria-hidden="true">#</a></h3><p>SQL编译其实是根据提供的查询参数进行占位符替换, 在使用量不高的情况下, 使用正则替换即可</p><h2 id="_4-研究与实现" tabindex="-1">4 研究与实现 <a class="header-anchor" href="#_4-研究与实现" aria-hidden="true">#</a></h2><h3 id="_4-1-sql抽象语法树" tabindex="-1">4.1 SQL抽象语法树 <a class="header-anchor" href="#_4-1-sql抽象语法树" aria-hidden="true">#</a></h3><p>Druid的SQL解析, 核心实际是它的SQL AST(<strong>A</strong>bstract <strong>S</strong>yntax <strong>T</strong>ree), 即SQL抽象语法树</p><p>在阅读<a href="https://github.com/alibaba/druid/wiki/Druid_SQL_AST" target="_blank" rel="noopener noreferrer">官方文档</a>后, 可以总结我们会用到的一些语法树节点:</p><ol><li><code>SQLSelectStatement</code>: 查询SQL节点</li><li><code>SQLTableSource</code>: 表节点</li><li><code>SQLSelect</code>: 查询节点</li><li><code>SQLSelectQueryBlock</code>: 查询块节点</li></ol><p>还有一些<code>SQLExpr</code>, 官方文档描述的不够详细, 需要在开发的时候进行测试</p><h3 id="_4-2-访问者模式" tabindex="-1">4.2 访问者模式 <a class="header-anchor" href="#_4-2-访问者模式" aria-hidden="true">#</a></h3><p>上一节中介绍了, SQL抽象语法树是核心, 那么怎么根据这棵语法树得到我们想要的结果呢?</p><p>Druid采用的是设计模式中的访问者模式</p><p>翻开以前学习过(<s>但从没用过</s>)的设计模式教材, 发现访问者模式的应用场景正是:</p><p>如果你需要对一个复杂对象结构 (例如<strong>对象树</strong>)中的所有元素执行某些操作，可使用访问者模式</p><p>那么对于我们而言, 只需要实现一个自己的访问者即可, 伪代码的使用逻辑大概如下:</p><div class="language-java"><pre><code><span class="token comment">// 生成语法树</span>
<span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select * from t_user&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">SQLSelectStatement</span> statement <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 访问并解析</span>
<span class="token class-name">MyVisitor</span> visitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyVisitor</span><span class="token punctuation">;</span>
statement<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取结果</span>
visitor<span class="token punctuation">.</span><span class="token function">getSelectColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
visitor<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-3-是否有轮子" tabindex="-1">4.3 是否有轮子? <a class="header-anchor" href="#_4-3-是否有轮子" aria-hidden="true">#</a></h3><p>Druid出自大厂之手, 必然会为我们提供很多使用的功能, 通过翻阅源码后, 找到了一个访问者: <code>SchemaStatVisitor</code></p><p>它的属性大概如下:</p><div class="language-java"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SchemaStatVisitor</span> <span class="token keyword">extends</span> <span class="token class-name">SQLASTVisitorAdapter</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Column</span><span class="token punctuation">&gt;</span></span>                  columns        <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Column</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Condition</span><span class="token punctuation">&gt;</span></span>                    conditions     <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Condition</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span>                  relationships  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Relationship</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Column</span><span class="token punctuation">&gt;</span></span>                       orderByColumns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Column</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Column</span><span class="token punctuation">&gt;</span></span>                        groupByColumns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Column</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SQLAggregateExpr</span><span class="token punctuation">&gt;</span></span>             aggregateFunctions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SQLAggregateExpr</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SQLMethodInvokeExpr</span><span class="token punctuation">&gt;</span></span>          functions          <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SQLMethodInvokeExpr</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>列<code>columns</code>, 查询条件<code>conditions</code>, 看似都齐了, 貌似今天可以划水了?</p><p>然而现实是残酷的, 它有致命的缺点:</p><ol><li>无法实现列别名</li><li>无法按我们规定的书写方式解析查询参数</li></ol><p>在简单研究后, 笔者决定放弃<code>SchemaStatVisitor</code>, 基于最原始的访问者接口<code>SQLASTVisitor</code>手动实现, 原因如下:</p><ol><li>需求简单, 且不支持复杂SQL</li><li>Druid的实现有自己一套体系, 例如<code>MySqlSchemaStatVisitor</code>就继承了<code>SchemaStatVisitor</code>, 所以后期其它开发人员介入, 需要进行不同数据源订制时, 坑和时间成本不可控</li><li><s>我想上手一下访问者模式</s></li></ol><h3 id="_4-4-创建模型" tabindex="-1">4.4 创建模型 <a class="header-anchor" href="#_4-4-创建模型" aria-hidden="true">#</a></h3><p>根据需求, 我们需要返回解析后的查询列和查询参数</p><p>创建查询列<code>SelectColumn</code>:</p><div class="language-java"><pre><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SelectColumn</span> <span class="token punctuation">{</span>

  <span class="token keyword">protected</span> <span class="token class-name">String</span> table<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token class-name">String</span> alias<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSelectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>查询参数用字符串数组<code>List&lt;String&gt;</code>即可</p><p>设计完上述两个模型后, 不着急开始写访问者, 我们好像遗漏了一些东西, 举个例子:</p><div class="language-sql"><pre><code><span class="token keyword">select</span> t<span class="token punctuation">.</span>name <span class="token keyword">from</span> t_user t
</code></pre></div><p>不光列有别名, 表也可能会产生别名</p><p>如果我们不对表进行处理, 在解析列时可能会出现<code>SelectColumn</code>的<code>table</code>属性赋值为<code>t</code>的情况, 这显示是有问题的</p><p>所以还需要对表进行解析, 创建<code>SelectTable</code>:</p><div class="language-java"><pre><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>houtaroy<span class="token punctuation">.</span>java<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>analyzer</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SelectTable</span> <span class="token punctuation">{</span>

  <span class="token keyword">protected</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token class-name">String</span> alias<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">SelectTable</span><span class="token punctuation">(</span><span class="token class-name">SQLExprTableSource</span> expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> expr<span class="token punctuation">.</span><span class="token function">getTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>alias <span class="token operator">=</span> expr<span class="token punctuation">.</span><span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-5-创建访问者" tabindex="-1">4.5 创建访问者 <a class="header-anchor" href="#_4-5-创建访问者" aria-hidden="true">#</a></h3><p>先观察一下接口<code>SQLASTVisitor</code>:</p><div class="language-java"><pre><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SQLASTVisitor</span> <span class="token punctuation">{</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">endVisit</span><span class="token punctuation">(</span><span class="token class-name">SQLAllColumnExpr</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">endVisit</span><span class="token punctuation">(</span><span class="token class-name">SQLBetweenExpr</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">endVisit</span><span class="token punctuation">(</span><span class="token class-name">SQLBinaryOpExpr</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">SQLAllColumnExpr</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">SQLBetweenExpr</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">SQLBinaryOpExpr</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>针对各种语法树节点, 提供了两个方法<code>visit</code>和<code>endVisit</code>, 至于这俩方法的含义就不用我多说了</p><p>需要注意的是, <code>visit</code>方法返回值为布尔类型, 列举出下面一段代码, 就能明白它的作用:</p><div class="language-java"><pre><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SQLSelectStatement</span> <span class="token keyword">extends</span> <span class="token class-name">SQLStatementImpl</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">accept0</span><span class="token punctuation">(</span><span class="token class-name">SQLASTVisitor</span> visitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>select <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>select<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        visitor<span class="token punctuation">.</span><span class="token function">endVisit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当<code>SQLSelectStatement</code>被访问时, 会先调用访问者访问自身</p><p>如果访问方法返回的是true, 则会继续执行, 让访问者访问它的属性<code>select</code></p><p><strong>所以, 如果我们自己定义了访问<code>SQLSelectStatement</code>的方法, 又在其中手动访问了它的<code>select</code>, 返回的还是<code>true</code></strong></p><p><strong>那就会访问两次<code>select</code>属性</strong></p><p>了解访问者机制后, 经过笔者的几番测试, 对4.1中提到的<code>SQLExpr</code>有了理解:</p><ol><li><code>SQLExprTableSource</code>: 数据库表的表达式, 可以提取表名/别名</li><li><code>SQLIdentifierExpr</code>: 确定表达式, 除了文档中的<code>id = 3</code>之外, 还有<code>select name from t_user</code>的<code>name</code></li><li><code>SQLAllColumnExpr</code>: 查询全部列表达式, 就是<code>select *</code>里的<code>*</code></li><li><code>SQLPropertyExpr</code>: 属性表达式, 例如<code>select t.name from t_user</code>中的<code>t.name</code>, 它的<code>owner</code>属性值为<code>t</code></li><li><code>SQLMethodInvokeExpr</code>: 函数表达式, 例如<code>select concat(name, email)</code>中的<code>concat(name, email)</code></li><li><code>SQLCharExpr</code>: 查询条件的字符串参数表达式, 例如<code>where name = &#39;Houtaroy&#39;</code>中的<code>&#39;Houtaroy&#39;</code></li><li><code>SQLVariantRefExpr</code>: 查询条件的变体表达式, 例如<code>where name = #{name}</code>中的<code>#{name}</code></li></ol><p>十分幸运, 所有的需求都可以对照上一个<code>SQLExpr</code>, 极大减少了开发的工作量</p><p>摸清楚这些内容后, 直接编写我们的访问者吧!</p><div class="language-java"><pre><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>houtaroy<span class="token punctuation">.</span>java<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>analyzer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>expr<span class="token punctuation">.</span></span><span class="token class-name">SQLAllColumnExpr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>expr<span class="token punctuation">.</span></span><span class="token class-name">SQLCharExpr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>expr<span class="token punctuation">.</span></span><span class="token class-name">SQLIdentifierExpr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>expr<span class="token punctuation">.</span></span><span class="token class-name">SQLMethodInvokeExpr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>expr<span class="token punctuation">.</span></span><span class="token class-name">SQLPropertyExpr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>expr<span class="token punctuation">.</span></span><span class="token class-name">SQLVariantRefExpr</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>statement<span class="token punctuation">.</span></span><span class="token class-name">SQLExprTableSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>statement<span class="token punctuation">.</span></span><span class="token class-name">SQLSelectItem</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>ast<span class="token punctuation">.</span>statement<span class="token punctuation">.</span></span><span class="token class-name">SQLSelectQueryBlock</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>visitor<span class="token punctuation">.</span></span><span class="token class-name">SQLASTVisitor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Optional</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span></span><span class="token class-name">Matcher</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span></span><span class="token class-name">Pattern</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 查询语句访问者
 * 只适用于select语句, 可以获取查询列名与查询参数
 * 查询参数书写格式为#{[a-zA-z]}
 *
 * @author Houtaroy
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;PMD&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SelectASTVisitor</span> <span class="token keyword">implements</span> <span class="token class-name">SQLASTVisitor</span> <span class="token punctuation">{</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Pattern</span> PARAMETER_PATTERN <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">&quot;#\\{[a-zA-z]*}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> PARAMETER_START_INDEX <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SQLSelectItem</span><span class="token punctuation">&gt;</span></span> selectItems <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectTable</span><span class="token punctuation">&gt;</span></span> selectTables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectColumn</span><span class="token punctuation">&gt;</span></span> selectColumns <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">endVisit</span><span class="token punctuation">(</span><span class="token class-name">SQLSelectQueryBlock</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">computeSelectColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">SQLExprTableSource</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    selectTables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SelectTable</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">SQLCharExpr</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">computeParameter</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">SQLSelectItem</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    selectItems<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">SQLVariantRefExpr</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">computeParameter</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 访问查询参数表达式, 匹配查询参数
   *
   * @param expr 查询参数表达式
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">computeParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> PARAMETER_PATTERN<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> match <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      parameters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>match<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>PARAMETER_START_INDEX<span class="token punctuation">,</span> match<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 计算查询列
   */</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">computeSelectColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    selectItems<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> alias <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">SQLIdentifierExpr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SQLIdentifierExpr</span> expr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SQLIdentifierExpr</span><span class="token punctuation">)</span> item<span class="token punctuation">.</span><span class="token function">getExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        selectColumns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SelectColumn</span><span class="token punctuation">(</span>selectTables<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expr<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">SQLAllColumnExpr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SQLAllColumnExpr</span> expr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SQLAllColumnExpr</span><span class="token punctuation">)</span> item<span class="token punctuation">.</span><span class="token function">getExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        selectColumns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SelectColumn</span><span class="token punctuation">(</span>selectTables<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">SQLMethodInvokeExpr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SQLMethodInvokeExpr</span> expr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SQLMethodInvokeExpr</span><span class="token punctuation">)</span> item<span class="token punctuation">.</span><span class="token function">getExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        selectColumns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SelectColumn</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> expr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">SQLPropertyExpr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SQLPropertyExpr</span> expr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SQLPropertyExpr</span><span class="token punctuation">)</span> item<span class="token punctuation">.</span><span class="token function">getExpr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        selectColumns<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SelectColumn</span><span class="token punctuation">(</span><span class="token function">getSelectTableNameByAlias</span><span class="token punctuation">(</span>expr<span class="token punctuation">.</span><span class="token function">getOwnerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expr<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          item<span class="token punctuation">.</span><span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 根据查询表别名获取查询表名
   * getSelectTableNameByAlias(&quot;t&quot;) -&gt; &quot;t_user&quot; or null
   *
   * @param alias 查询表别名
   * @return 查询表名
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getSelectTableNameByAlias</span><span class="token punctuation">(</span><span class="token class-name">String</span> alias<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getSelectTableByAlias</span><span class="token punctuation">(</span>alias<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SelectTable</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 根据查询表别名获取查询表
   *
   * @param alias 查询表别名
   * @return 查询表
   */</span>
  <span class="token keyword">protected</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectTable</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSelectTableByAlias</span><span class="token punctuation">(</span><span class="token class-name">String</span> alias<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> selectTables<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>table <span class="token operator">-&gt;</span> alias<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span><span class="token function">getAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_4-6-sql注入检查" tabindex="-1">4.6 SQL注入检查 <a class="header-anchor" href="#_4-6-sql注入检查" aria-hidden="true">#</a></h3><p>Druid提供了<code>WallProvider</code>, 用于检查SQL语句, 并贴心的为我们准备了各种实现</p><p>使用代码很简单, 以MySQL为例:</p><div class="language-java"><pre><code><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select * from t_user where id = &#39;1&#39; and &#39;1&#39;=&#39;1&#39;&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">WallProvider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySqlWallProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">WallCheckResult</span> result <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getViolations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 无SQL注入风险和错误, 可执行查询</span>
<span class="token punctuation">}</span>
</code></pre></div><p>是不是非常好理解?在这里就不着过多笔墨了</p><h2 id="_5-总结" tabindex="-1">5 总结 <a class="header-anchor" href="#_5-总结" aria-hidden="true">#</a></h2><p>最后总结下本次实践中学习到的知识:</p><ol><li>抽象语法树</li><li>访问者模式</li><li>Druid SQL Parser</li><li>Druid WallProvider</li><li>根据实际需求进行技术选型, <strong>没有银弹</strong></li></ol><p>笔者后续还做了一些其它工作, 各位也可以进行思考拓展:</p><ol><li>如何获取查询列的数据类型?</li><li>能否推断出查询参数的数据类型?</li><li><code>WallProvider</code>可否进行单例模式封装?</li></ol><p>所有代码均上传至<a href="https://github.com/Houtaroy/java-lab" target="_blank" rel="noopener noreferrer">Github</a></p><p>我是Houtaroy, 哪怕只有一行代码可以为他人提供帮助, 那也是在下毕生的荣幸</p></div></div><footer class="page-footer" data-v-30e7de44 data-v-504b1bfc><div class="edit" data-v-504b1bfc><div class="edit-link" data-v-504b1bfc data-v-40c300d5><!----></div></div><div class="updated" data-v-504b1bfc><!----></div></footer><div class="next-and-prev-link" data-v-30e7de44 data-v-0f10f042><div class="container" data-v-0f10f042><div class="prev" data-v-0f10f042><a class="link" href="/wiki/java/开发手册" data-v-0f10f042><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-0f10f042><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-0f10f042>开发手册</span></a></div><div class="next" data-v-0f10f042><a class="link" href="/wiki/java/SpringBoot整合钉钉SDK" data-v-0f10f042><span class="text" data-v-0f10f042>SpringBoot整合钉钉SDK</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-0f10f042><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"3818ae6a\",\"java_springboot整合elasticsearch_index.md\":\"7b633122\",\"java_springboot整合钉钉sdk.md\":\"c26aa1a8\",\"java_springcloud分布式事务seata.md\":\"03353e86\",\"java_index.md\":\"19a7e8a6\",\"java_使用druid解析sql查询语句.md\":\"fed2d013\",\"java_开发手册.md\":\"668b2141\",\"training-record_micro-service.md\":\"9034774f\"}")</script>
    <script type="module" async src="/wiki/assets/app.7004e06b.js"></script>
    
  </body>
</html>